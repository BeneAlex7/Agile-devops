name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop

permissions:
  contents: write
  pull-requests: write

jobs:
  # Job 1 : Tests & Qualité
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd inventory-api
          pip install -r requirements.txt

      - name: Linting with flake8
        run: |
          cd inventory-api
          # stop the build if there are Python syntax errors or undefined names
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
          flake8 app/ --count --max-line-length=100 --statistics

      - name: Run tests with pytest
        run: |
          cd inventory-api
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          pytest tests/ -v

  # Job 2 : Build & Sécurité
  build_and_security:
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build Docker image
        run: |
          cd inventory-api
          docker build -t inventory-api:test .

      - name: Check image size
        run: |
          SIZE=$(docker inspect inventory-api:test --format='{{.Size}}')
          SIZE_MB=$((SIZE / 1024 / 1024))
          echo "Image size: ${SIZE_MB}MB"
          if [ $SIZE_MB -ge 100 ]; then
            echo "Error: Image size exceeds 100MB"
            exit 1
          fi

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'inventory-api:test'
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  # Job 3 : Pull Request Auto
  create_pr:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    needs: [quality, build_and_security]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create Pull Request from develop to main
        uses: repo-sync/pull-request@v2
        with:
          destination_branch: "main"
          source_branch: "develop"
          pr_title: "Release: Develop to Main"
          pr_body: "Automated PR created by CI/CD pipeline after successful tests and build on develop branch."
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # Job 4 : Déploiement Production
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [quality, build_and_security]
    steps:
      - name: Deploy to Production
        run: |
          echo "DEPLOYMENT TO PRODUCTION"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Date: $(date)"
          echo "Environment: PRODUCTION"
          # Ici, on ajouterait les scripts de déploiement réels (SSH, Kubernetes, etc.)
